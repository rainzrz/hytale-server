services:
  hytale-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hytale-server
    restart: unless-stopped
    networks:
      - hytale-network

    ports:
      # QUIC protocol uses UDP
      - "${SERVER_PORT:-5520}:${SERVER_PORT:-5520}/udp"

    environment:
      - JAVA_OPTS=${JAVA_OPTS:--Xms2G -Xmx4G}
      - SERVER_PORT=${SERVER_PORT:-5520}
      - USE_AOT_CACHE=${USE_AOT_CACHE:-true}
      - EXTRA_ARGS=${EXTRA_ARGS:-}

    volumes:
      # Persistent data
      - ./data/universe:/server/universe
      - ./data/mods:/server/mods
      - ./data/logs:/server/logs
      - ./data/.cache:/server/.cache
      # Config files (server creates/updates these automatically)
      - ./data/config.json:/server/config.json
      - ./data/permissions.json:/server/permissions.json
      - ./data/whitelist.json:/server/whitelist.json
      - ./data/bans.json:/server/bans.json

    # Limit resources
    deploy:
      resources:
        limits:
          memory: 14G
        reservations:
          memory: 10G

    # For interactive console (authentication)
    stdin_open: true
    tty: true

  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    networks:
      - hytale-network
    ports:
      - "3001:3001"
    volumes:
      - ./data/uptime-kuma:/app/data
    healthcheck:
      test: ["CMD", "node", "extra/healthcheck.js"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 180s

  discord-bot:
    build:
      context: ./discord-bot
      dockerfile: Dockerfile
    container_name: discord-bot
    restart: unless-stopped
    networks:
      - hytale-network
    environment:
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - DISCORD_CHANNEL_ID=${DISCORD_CHANNEL_ID}
      - KUMA_API_KEY=${KUMA_API_KEY}
      - KUMA_URL=${KUMA_URL:-http://uptime-kuma:3001/api/status-page/heartbeat/hytale}
    depends_on:
      - uptime-kuma
      - hytale-server

networks:
  hytale-network:
    driver: bridge
